---
cssclass: light-note
---

# 2025-10-14

## 超长文档交付目标
- **对象**：100+ 页的技术/业务 PDF，含大量数据表与跨章节引用。
- **产出**：高保真双语 Markdown → PDF，可追踪译前/译后/校对差异，数据表准确率 ≥ 99%。
- **策略**：预处理分块 + MinerU 精准抽取 + LLM-Studio 多阶段流水线 + 表格专用校验 → 最终 QA 自动化。

## 预处理与分块规划
- 运行 `doc-analyzer` 脚本统计页数、表格密度、术语出现频率，输出 YAML 供后续节点读取。
- 对超过 150 页的文档先按章节/目录分卷；单卷控制在 45 MB、2k 段落以内，便于并行排队。
- 基于 YAML 生成执行计划（分块权重、优先级、敏感章节标记）；在队列中优先处理指标章节与表格密集页。

## MinerU 2.5 抽取强化
- `layout_preservation=true` + `segment_mode=hybrid`；对检测到的大表启用 `table_mode=dense-grid`，保留单元格坐标。
- 自定义 `table_schema_rules.yml` 判断财务表、时序表；命中后导出结构化 JSON 供表格子流引用。
- 设置 `max_block_length=360`（正文）与 `max_block_length=220`（表格相关文本）并开启智能合并，避免跨列断句。
- 在预处理节点启用 OCR 兜底：若页面列出“低置信度”字段，则调用 OCR 纠错并附原图供回溯。

## LLM-Studio 多阶段流水线
- **文段翻译节点**：块大小 1.1k tokens，上下文重叠 150；Prompt 包含术语表、章节上下文、语体要求；推理参数 `temperature=0.15`、`top_p=0.7` 保守输出。
- **表格专用翻译节点**：对 MinerU 导出的表格 JSON 逐表处理，Prompt 指定列名对齐、数值不可改动、保留单位；输出 Markdown 表 + JSON 回写校验信息。
- **术语守护子流**：利用术语向量库 + 正则，对关键名词、缩写、单位做双重检测；发现偏差即回写到翻译节点重试。
- **校对节点**：第一轮语义核对（关注遗漏与指代）、第二轮格式校对（列表/表格/脚注）；对表格行列数变化报警。
- **合并节点**：按章节组装，合成 `merged.md` 与 `tables.jsonl`，输出 diff 与术语变更日志。

## 表格质量加固
- 引入 Table QA 子流：比对原 JSON 与译后 JSON，校验列顺序、行数、合并单元格、数值一致性；不匹配则自动提交回炉任务。
- 对货币/百分比字段运行精度校验，误差超过 0.1% 直接标红；支持浮点与千分位格式互转。
- 为多页横向表构建分页合并逻辑，确保译后 Markdown 表格可被 Pandoc 正确渲染；必要时转为 HTML 表并嵌入。

## QA 与导出
- YAML 驱动 QA 扩展：新增 `table_structure`、`numeric_consistency`、`reference_backlink` 检查项。
- 自动抽样 10% 的章节生成中英对照快照（含表格截图），供人工 spot check；抽样规则覆盖高风险章节。
- Pandoc 导出：`pandoc merged.md -o deliverable.pdf --from gfm --pdf-engine=xelatex --variable mainfont='Source Han Serif' --table-of-contents --toc-depth=3`。
- 导出后跑 `final-audit` 脚本，汇总 QA 日志、表格差异、术语统计，存入审计库。

## 调度与弹性
- 启用 Runner 池：并行度按 `min(6, ceil(total_blocks/12))` 控制，避免长文档导致 Redis 队列拥塞。
- 针对 100+ 页流程设超时监控：单块 >6 分钟或表格节点 >3 分钟自动告警并记录重试次数。
- 所有中间结果（Markdown block、表格 JSON、QA 报告）写入 `mineru_runs/<date>/<doc_id>/`，便于复现与回滚。

## 后续提升方向
1. 接入自定义表格渲染器，将 JSON → LaTeX 表格流程模板化，减少 Pandoc 对复杂表的依赖。
2. 扩展术语守护子流，对跨项目共享的术语库做版本化管理，并支持 diff 回顾。
3. 构建文档级质量仪表盘（准确率、表格通过率、平均处理时长），支撑回归测试与 SLA 追踪。

## 今日总结
- 调整笔记背景方案：尝试内嵌 CSS 与 Obsidian snippet，但当前查看器仍强制深色主题，需结合自定义代理或主题设置才能生效。
- n8n 升级排查：多次切换镜像源与 compose 标签尝试拉取 1.15.3，因网络/镜像限制未能成功，现仍运行 1.115.2。
- 长文翻译流程：完善 100+ 页处理策略与表格 QA 方案，并生成 n8n 工作流导出 `notes/2025-10-14-n8n-workflow.json` 支撑落地。
